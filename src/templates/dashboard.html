{% extends "base.html" %}

{% block title %}Dashboard - Vienna Apartment Tracker{% endblock %}

{% block content %}
<div class="space-y-8">
    <!-- Header -->
    <div>
        <h1 class="text-3xl font-bold mb-2">Apartment Price Dashboard</h1>
        <p class="text-zinc-400">Track Vienna apartment listings and price trends</p>
    </div>

    <!-- Price Stats Cards -->
    <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
        <div class="card p-6 gradient-border">
            <div class="text-zinc-400 text-sm font-medium mb-2">Median Price</div>
            <div class="stat-value">‚Ç¨{{ "{:,.0f}".format(median_price) }}</div>
            <div class="text-zinc-500 text-sm mt-2">Middle value of all listings</div>
        </div>
        <div class="card p-6 gradient-border">
            <div class="text-zinc-400 text-sm font-medium mb-2">Average Price</div>
            <div class="text-3xl font-bold text-amber-400">‚Ç¨{{ "{:,.0f}".format(avg_price) }}</div>
            <div class="text-zinc-500 text-sm mt-2">Mean of all listings</div>
        </div>
        <div class="card p-6 gradient-border">
            <div class="text-zinc-400 text-sm font-medium mb-2">Average ‚Ç¨/m¬≤</div>
            <div class="text-3xl font-bold text-rose-400">‚Ç¨{{ "{:,.0f}".format(avg_price_per_sqm) }}</div>
            <div class="text-zinc-500 text-sm mt-2">Price per square meter</div>
        </div>
    </div>

    <!-- Market Trends Card -->
    <div class="card p-6">
        <h2 class="text-lg font-semibold mb-4">Market Trends</h2>
        <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
            <div class="bg-zinc-800/50 rounded-lg p-4">
                <div class="text-zinc-400 text-sm mb-1">Avg Price Change</div>
                <div class="flex items-center gap-2">
                    <span class="text-2xl font-bold {% if market_trends.price_change_pct > 0 %}text-rose-400{% elif market_trends.price_change_pct < 0 %}text-teal-400{% else %}text-zinc-400{% endif %}">
                        {% if market_trends.price_change_pct > 0 %}‚Üë{% elif market_trends.price_change_pct < 0 %}‚Üì{% else %}‚Üí{% endif %}
                        {{ "{:.1f}".format(market_trends.price_change_pct|abs) }}%
                    </span>
                </div>
                <div class="text-zinc-500 text-xs mt-1">vs previous scrape</div>
            </div>
            <div class="bg-zinc-800/50 rounded-lg p-4">
                <div class="text-zinc-400 text-sm mb-1">Avg ‚Ç¨/m¬≤ Change</div>
                <div class="flex items-center gap-2">
                    <span class="text-2xl font-bold {% if market_trends.ppsqm_change_pct > 0 %}text-rose-400{% elif market_trends.ppsqm_change_pct < 0 %}text-teal-400{% else %}text-zinc-400{% endif %}">
                        {% if market_trends.ppsqm_change_pct > 0 %}‚Üë{% elif market_trends.ppsqm_change_pct < 0 %}‚Üì{% else %}‚Üí{% endif %}
                        {{ "{:.1f}".format(market_trends.ppsqm_change_pct|abs) }}%
                    </span>
                </div>
                <div class="text-zinc-500 text-xs mt-1">vs previous scrape</div>
            </div>
            <div class="bg-zinc-800/50 rounded-lg p-4">
                <div class="text-zinc-400 text-sm mb-1">Listing Count Change</div>
                <div class="flex items-center gap-2">
                    <span class="text-2xl font-bold {% if market_trends.count_change > 0 %}text-teal-400{% elif market_trends.count_change < 0 %}text-rose-400{% else %}text-zinc-400{% endif %}">
                        {% if market_trends.count_change > 0 %}+{% endif %}{{ market_trends.count_change }}
                    </span>
                </div>
                <div class="text-zinc-500 text-xs mt-1">{{ market_trends.current_count }} total listings</div>
            </div>
        </div>
    </div>

    <!-- Listing Count Cards -->
    <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
        <div class="card p-6">
            <div class="text-zinc-400 text-sm font-medium mb-2">Open Listings</div>
            <div class="text-2xl font-bold text-teal-400">{{ total_open }}</div>
            <div class="text-zinc-500 text-sm mt-2">Currently active</div>
        </div>
        <div class="card p-6">
            <div class="text-zinc-400 text-sm font-medium mb-2">Closed Listings</div>
            <div class="text-2xl font-bold text-zinc-500">{{ total_closed }}</div>
            <div class="text-zinc-500 text-sm mt-2">No longer available</div>
        </div>
        <div class="card p-6">
            <div class="text-zinc-400 text-sm font-medium mb-2">Total Tracked</div>
            <div class="text-2xl font-bold text-zinc-300">{{ total_open + total_closed }}</div>
            <div class="text-zinc-500 text-sm mt-2">All time</div>
        </div>
    </div>

    <!-- Charts Row 1 -->
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
        <!-- Price Distribution Histogram -->
        <div class="card p-6">
            <h2 class="text-lg font-semibold mb-4">Price Distribution</h2>
            <div id="histogram-chart" style="height: 300px;"></div>
        </div>
        
        <!-- Price per sqm by District -->
        <div class="card p-6">
            <h2 class="text-lg font-semibold mb-4">Average ‚Ç¨/m¬≤ by District</h2>
            <div id="price-sqm-district-chart" style="height: 300px;"></div>
        </div>
    </div>

    <!-- Charts Row 2 -->
    <div class="grid grid-cols-1 gap-6">
        <!-- Price Over Time -->
        <div class="card p-6">
            <h2 class="text-lg font-semibold mb-4">Average Price Over Time</h2>
            <div id="price-chart" style="height: 300px;"></div>
        </div>
    </div>

    <!-- Best Value Finder -->
    <div class="card p-6">
        <h2 class="text-lg font-semibold mb-4">üèÜ Best Value Listings (Lowest ‚Ç¨/m¬≤)</h2>
        <div class="overflow-x-auto">
            <table class="w-full text-left">
                <thead class="text-zinc-400 text-sm border-b border-zinc-700">
                    <tr>
                        <th class="pb-3 pr-4">Title</th>
                        <th class="pb-3 pr-4">Location</th>
                        <th class="pb-3 pr-4">Price</th>
                        <th class="pb-3 pr-4">‚Ç¨/m¬≤</th>
                        <th class="pb-3 pr-4">Size</th>
                        <th class="pb-3">Action</th>
                    </tr>
                </thead>
                <tbody class="text-sm">
                    {% for listing in best_value_listings %}
                    <tr class="table-row border-b border-zinc-800">
                        <td class="py-3 pr-4 max-w-xs truncate" title="{{ listing.title }}">
                            <a href="/listing/{{ listing.id }}" class="hover:text-teal-400">{{ listing.title }}</a>
                        </td>
                        <td class="py-3 pr-4 text-zinc-400">{{ listing.location }}</td>
                        <td class="py-3 pr-4 font-semibold text-teal-400">{{ listing.price }}</td>
                        <td class="py-3 pr-4">
                            <span class="px-2 py-1 rounded-full text-xs bg-amber-400/20 text-amber-400 font-semibold">
                                ‚Ç¨{{ "{:,.0f}".format(listing.price_per_sqm) }}
                            </span>
                        </td>
                        <td class="py-3 pr-4">{{ listing.size_sqm }} m¬≤</td>
                        <td class="py-3">
                            <a href="{{ listing.url }}" target="_blank" class="text-teal-400 hover:text-teal-300">View</a>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>

    <!-- Best Value by District -->
    <div class="card p-6">
        <h2 class="text-lg font-semibold mb-4">ü•á Best Deal per District</h2>
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
            {% for listing in best_by_district %}
            <div class="bg-zinc-800/50 rounded-lg p-4 hover:bg-zinc-800 transition-colors">
                <div class="flex items-start justify-between mb-2">
                    <span class="text-xs text-zinc-400">{{ listing.location.split(',')[1] if ',' in listing.location else listing.location }}</span>
                    <span class="px-2 py-0.5 rounded-full text-xs bg-teal-400/20 text-teal-400 font-semibold">
                        ‚Ç¨{{ "{:,.0f}".format(listing.price_per_sqm) }}/m¬≤
                    </span>
                </div>
                <div class="text-sm font-medium truncate mb-1" title="{{ listing.title }}">
                    <a href="/listing/{{ listing.id }}" class="hover:text-teal-400">{{ listing.title }}</a>
                </div>
                <div class="flex items-center justify-between text-xs text-zinc-500">
                    <span>{{ listing.price }} ¬∑ {{ listing.size_sqm }} m¬≤</span>
                    <a href="{{ listing.url }}" target="_blank" class="text-teal-400 hover:text-teal-300">View ‚Üí</a>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>

    <!-- Recent Scrape Runs -->
    <div class="card p-6">
        <h2 class="text-lg font-semibold mb-4">Recent Scrape Runs</h2>
        <div class="overflow-x-auto">
            <table class="w-full text-left">
                <thead class="text-zinc-400 text-sm border-b border-zinc-700">
                    <tr>
                        <th class="pb-3 pr-4">Started</th>
                        <th class="pb-3 pr-4">Status</th>
                        <th class="pb-3 pr-4">Found</th>
                        <th class="pb-3 pr-4">New</th>
                        <th class="pb-3">Closed</th>
                    </tr>
                </thead>
                <tbody class="text-sm">
                    {% for run in recent_runs %}
                    <tr class="table-row border-b border-zinc-800">
                        <td class="py-3 pr-4">{{ run.started_at }}</td>
                        <td class="py-3 pr-4">
                            {% if run.status == 'completed' %}
                            <span class="px-2 py-1 rounded-full text-xs badge-open">Completed</span>
                            {% elif 'failed' in run.status %}
                            <span class="px-2 py-1 rounded-full text-xs badge-closed">Failed</span>
                            {% else %}
                            <span class="px-2 py-1 rounded-full text-xs bg-zinc-700 text-zinc-300">{{ run.status }}</span>
                            {% endif %}
                        </td>
                        <td class="py-3 pr-4">{{ run.listings_found or '-' }}</td>
                        <td class="py-3 pr-4">{{ run.new_listings or '-' }}</td>
                        <td class="py-3">{{ run.closed_listings or '-' }}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    const priceOverTime = {{ price_over_time_json | safe }};
    const pricePerSqmByDistrict = {{ price_per_sqm_by_district_json | safe }};
    const priceDistribution = {{ price_distribution_json | safe }};

    // Price Distribution Histogram
    if (priceDistribution.length > 0) {
        const histTrace = {
            x: priceDistribution.map(d => `‚Ç¨${(d.bucket_start/1000).toFixed(0)}k-${(d.bucket_end/1000).toFixed(0)}k`),
            y: priceDistribution.map(d => d.count),
            type: 'bar',
            marker: {
                color: priceDistribution.map((d, i) => {
                    // Gradient from teal to amber based on price
                    const ratio = i / priceDistribution.length;
                    return `rgba(${Math.round(45 + ratio * 206)}, ${Math.round(212 - ratio * 23)}, ${Math.round(191 - ratio * 155)}, 0.8)`;
                })
            }
        };

        Plotly.newPlot('histogram-chart', [histTrace], {
            paper_bgcolor: 'transparent',
            plot_bgcolor: 'transparent',
            font: { color: '#a1a1aa', size: 10 },
            margin: { t: 20, r: 20, b: 80, l: 50 },
            xaxis: { 
                gridcolor: '#27272a',
                linecolor: '#27272a',
                tickangle: -45,
                title: { text: 'Price Range', standoff: 15 }
            },
            yaxis: { 
                gridcolor: '#27272a',
                linecolor: '#27272a',
                title: { text: 'Number of Listings', standoff: 10 }
            }
        }, { responsive: true });
    } else {
        document.getElementById('histogram-chart').innerHTML = '<div class="text-zinc-500 text-center py-12">No data yet.</div>';
    }

    // Price over time chart
    if (priceOverTime.length > 0) {
        const priceTrace = {
            x: priceOverTime.map(d => d.date),
            y: priceOverTime.map(d => d.avg_price),
            type: 'scatter',
            mode: 'lines+markers',
            name: 'Avg Price',
            line: { color: '#2dd4bf', width: 2 },
            marker: { size: 6 },
            fill: 'tozeroy',
            fillcolor: 'rgba(45, 212, 191, 0.1)'
        };

        Plotly.newPlot('price-chart', [priceTrace], {
            paper_bgcolor: 'transparent',
            plot_bgcolor: 'transparent',
            font: { color: '#a1a1aa' },
            margin: { t: 20, r: 20, b: 40, l: 70 },
            xaxis: { 
                gridcolor: '#27272a',
                linecolor: '#27272a'
            },
            yaxis: { 
                gridcolor: '#27272a',
                linecolor: '#27272a',
                tickformat: '‚Ç¨,.0f'
            }
        }, { responsive: true });
    } else {
        document.getElementById('price-chart').innerHTML = '<div class="text-zinc-500 text-center py-12">No data yet. Run the scraper to collect data.</div>';
    }

    // Price per sqm by district chart
    if (pricePerSqmByDistrict.length > 0) {
        const districtTrace = {
            x: pricePerSqmByDistrict.slice(0, 10).map(d => d.location),
            y: pricePerSqmByDistrict.slice(0, 10).map(d => d.avg_price_per_sqm),
            type: 'bar',
            marker: {
                color: pricePerSqmByDistrict.slice(0, 10).map((_, i) => {
                    const colors = ['#f43f5e', '#fbbf24', '#2dd4bf', '#a78bfa', '#60a5fa', '#ec4899', '#84cc16', '#06b6d4', '#f97316', '#8b5cf6'];
                    return colors[i % colors.length];
                })
            }
        };

        Plotly.newPlot('price-sqm-district-chart', [districtTrace], {
            paper_bgcolor: 'transparent',
            plot_bgcolor: 'transparent',
            font: { color: '#a1a1aa', size: 10 },
            margin: { t: 20, r: 20, b: 120, l: 60 },
            xaxis: { 
                gridcolor: '#27272a',
                linecolor: '#27272a',
                tickangle: -45
            },
            yaxis: { 
                gridcolor: '#27272a',
                linecolor: '#27272a',
                tickformat: '‚Ç¨,.0f',
                title: { text: '‚Ç¨/m¬≤', standoff: 10 }
            }
        }, { responsive: true });
    } else {
        document.getElementById('price-sqm-district-chart').innerHTML = '<div class="text-zinc-500 text-center py-12">No data yet.</div>';
    }
</script>
{% endblock %}
